#!/usr/bin/env python3
import sys, requests

def main():
    if len(sys.argv) != 3:
        print("Usage: ./git-ssh-keys <fingerprint> <key>", file=sys.stderr)
        sys.exit(1)

    fp, key = sys.argv[1], sys.argv[2]
    token_file = "/etc/forgejo/git-ssh"
    api_url = f"https://forge.jackturk.dev/api/v1/keys/{fp}"

    # Read token
    try:
        token = open(token_file).read().strip()
    except IOError:
        print(f"ERROR: Cannot read token file {token_file}", file=sys.stderr)
        sys.exit(1)

    # Fetch key object
    headers = {
        "Accept": "application/json",
        "Authorization": f"token {token}",
    }
    resp = requests.get(api_url, headers=headers, timeout=5)
    if resp.status_code != 200:
        print(f"ERROR: HTTP {resp.status_code} from {api_url}", file=sys.stderr)
        sys.exit(1)

    # Parse JSON
    try:
        obj = resp.json()
        owner = obj["owner"]["login"]
        fp   = obj["fingerprint"]
    except (ValueError, KeyError) as e:
        print(f"ERROR: Invalid JSON or missing fields: {e}", file=sys.stderr)
        sys.exit(1)

    # Output authorized_keys line
    print(
        f'no-port-forwarding,no-pty,'
        f'command="gitea serv key-lookup -e git -u {owner} -t {fp} -k {key}" {key}'
    )

if __name__ == "__main__":
    main()