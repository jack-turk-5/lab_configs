# === Stage 1: Build Boringtun CLI ===
FROM docker.io/rust:alpine AS builder
RUN apk add --no-cache build-base musl-dev linux-headers \
    && cargo install --locked boringtun-cli \
    && apk del build-base musl-dev linux-headers

# === Stage 2: Final Image on WGDashboard Base ===
FROM docker.io/donaldzou/wgdashboard:latest

# Install runtime dependencies
USER root

# Copy Boringtun binary from builder stage
COPY --from=builder /usr/local/cargo/bin/boringtun-cli /usr/bin/boringtun-cli

# Add dependencies and allow net admin
RUN apk add --no-cache socat wireguard-tools iproute2 bash libcap-setcap \
    && setcap cap_net_admin+epi /usr/bin/boringtun-cli

# Add our unified entrypoint
COPY entrypoint.sh /entrypoint-custom.sh
RUN chmod +x /entrypoint-custom.sh

ENTRYPOINT ["/entrypoint-custom.sh"]