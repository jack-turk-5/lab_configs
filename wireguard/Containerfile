# ────────────────
# Stage 1: Alpine builder (musl + git)
# ────────────────
FROM alpine:3.18 AS builder

# Install build tools, clone embeddable‑wg sources
RUN apk add --no-cache \
      build-base \
      linux-headers \
      git \
      iproute2

RUN git clone https://git.zx2c4.com/wireguard-tools.git /wireguard-tools

# Copy only the embeddable library + our shim
WORKDIR /wireguard-tools/contrib/embeddable-wg-library
COPY shim.c .

# Compile static with musl (no libsystemd)
RUN gcc -O2 -g shim.c wireguard.c \
    -o /usr/local/bin/wg-shim

# ────────────────
# Stage 2: Final (wg-easy base)
# ────────────────
FROM ghcr.io/wg-easy/wg-easy:latest
RUN apk add --no-cache socat iproute2
# Copy statically‑linked shim
COPY --from=builder /usr/local/bin/wg-shim /usr/local/bin/wg-shim

# Make sure entrypoint calls wg-shim then UI
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/wg-shim /usr/local/bin/entrypoint.sh

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]