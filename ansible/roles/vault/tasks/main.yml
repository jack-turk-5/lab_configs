---
- name: Create Vaultwarden config directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "~/.config/vault"

- name: Create Vaultwarden data directory with strict permissions
  ansible.builtin.file:
    path: "~/.config/vault/data"
    state: directory
    mode: '0700'

- name: Copy Vaultwarden environment file
  ansible.builtin.copy:
    src: vault.env
    dest: "~/.config/vault/env"
    mode: '0600'

- name: Copy Vaultwarden systemd unit to user quadlet directory
  ansible.builtin.copy:
    src: vault.container
    dest: "~/.config/containers/systemd/"

- name: Reload systemd user daemon to detect new units
  ansible.builtin.systemd:
    scope: user
    daemon_reload: yes

- name: Ensure Vaultwarden service is started and enabled
  ansible.builtin.systemd:
    scope: user
    name: vault
    enabled: yes
    state: started
