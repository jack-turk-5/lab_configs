---
- name: "Manage backup configuration for {{ backup_item.name }}"
  block:
    - name: "Ensure user directories exist for {{ backup_item.name }}"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ ansible_facts['user_dir'] }}/.local/bin"
        - "{{ ansible_facts['user_dir'] }}/.config/systemd/user"
        - "{{ backup_item.local_backup_dir }}"

    - name: "Copy backup script for {{ backup_item.name }}"
      ansible.builtin.template:
        src: "{{ (backup_item | default({})).backup_script_template | default('backup.sh.j2') }}"
        dest: "{{ ansible_facts['user_dir'] }}/.local/bin/backup-{{ backup_item.name }}.sh"
        mode: '0755'
      vars:
        # Pass all backup_item variables to the template
        backup_name: "{{ backup_item.name }}"
        source_dirs: "{{ backup_item.source_dirs }}"
        local_backup_dir: "{{ backup_item.local_backup_dir }}"
        rclone_remote: "{{ backup_item.rclone_remote }}"
        remote_dir: "{{ backup_item.remote_dir }}"
        local_retention_days: "{{ backup_item.local_retention_days }}"
        service_name: "{{ backup_item.service_name }}"

    - name: "Copy systemd service file for {{ backup_item.name }}"
      ansible.builtin.template:
        src: backup.service.j2
        dest: "{{ ansible_facts['user_dir'] }}/.config/systemd/user/backup-{{ backup_item.name }}.service"
        mode: '0644'

    - name: "Copy systemd timer file for {{ backup_item.name }}"
      ansible.builtin.template:
        src: backup.timer.j2
        dest: "{{ ansible_facts['user_dir'] }}/.config/systemd/user/backup-{{ backup_item.name }}.timer"
        mode: '0644'

    - name: "Reload systemd daemon for user ({{ ansible_facts['user_id'] }})"
      ansible.builtin.systemd:
        scope: user
        daemon_reload: true

    - name: "Enable and start the user backup timer for {{ backup_item.name }}"
      ansible.builtin.systemd:
        scope: user
        name: "backup-{{ backup_item.name }}.timer"
        enabled: true
        state: started

- name: "Prompt user to configure rclone for current user"
  ansible.builtin.debug:
    msg:
      - "IMPORTANT: The backup system is installed for the '{{ ansible_facts['user_id'] }}' user, but you must configure rclone for it to work."
      - "---"
      - "Log in to your server as the '{{ ansible_facts['user_id'] }}' user and run:"
      - "  rclone config"
      - "---"
      - "Follow the prompts to set up a new remote. It is recommended to name it 'gdrive' as this is the default in the backup configuration."

